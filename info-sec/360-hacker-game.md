Title: 360网络攻防游戏心得
Date: 2014-08-05 08:20:24
toc: no
status: private

![360网络攻防](/_image/2014-05-09/08-32-50.jpg)

最近在一个新项目上，创业公司，节奏非常快，加班太多，很久没有更新博客了，翻出之前写了一半的此篇，终于将其写完。

### 写在前面
随着媒体对各种“黑客”事件的曝光，信息安全一度成为热门话题。尤其是在当今社会，人们的生活对各种软件服务的依赖越来越重，以至于马斯洛需求层次图都要进行修改。

如果你觉得信息安全离你很遥远，不防看看下面这个网站。[密码丢了没](http://www.594sgk.com/)

比起普通用户，作为软件从业人员的我们，更应当增强信息安全意识，熟悉相关的技术，知攻而后防，写出更好的软件，避免给用户的数据带来威胁。

由于一直对网络安全保持关注，所以第一时间知道了[@360网络攻防实验室](http://weibo.com/u/3957583411)搞的这个[#360技术牛人挑战赛#](http://weibo.com/p/1008085a5fa88786b795b5c0ec7a7574f4e7dc?k=360%E6%8A%80%E6%9C%AF%E7%89%9B%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9B&from=huati_topic)，不失为一个学习交流的好机会。
不多说了，开始闯关吧。

### 第一关
[![第一关](/_image/2014-05-06/08-06-19.jpg)](http://attack.onebox.so.com/c6c299rf-main.html)

#### 考核点
服务器端对HTTP Header中的`Referer`属性进行校验。
通常用于来源统计和防盗链，但极容易被伪造。

#### 过关方法
* 通过Burp之类的工具，拦截HTTP请求，修改`Referer`属性的值为`http://hack.360.cn`
* 如果没有Burp，curl应该也是可以的:
```
curl --referer http://hack.360.cn http://attack.onebox.so.com/c6c299rf-check.html
```
#### 扩展
维基百科：[HTTP来源地址](http://zh.wikipedia.org/wiki/HTTP%E5%8F%82%E7%85%A7%E4%BD%8D%E5%9D%80)

### 第二关
[![第二关](/_image/2014-05-06/08-54-47.jpg)](http://attack.onebox.so.com/jaa60cjse-main.html)

#### 考核点
JavaScript混淆。

#### 过关方法
通过查看源代码发现加载了一个js文件代码如下：
```
var password = eval(function(p,a,c,k,e,d){e=function(c){return(c<a?"":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d[e(c)]=k[c]||e(c);k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1;};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p;}('9 5$=["\\8\\3\\4\\3\\2\\2\\1\\3\\2\\3\\3\\2\\2\\7\\3\\1\\4\\1\\3\\2\\1\\3\\1\\3\\2\\2\\2\\1\\3\\4\\1\\3\\2\\1\\4\\1\\3\\2\\1\\4\\1\\3\\2\\2\\1\\3\\4\\1\\3\\2\\1\\4\\1\\3\\2\\1\\4\\1\\3\\2\\1\\4\\1\\3\\2\\1\\4\\1\\3\\2\\1\\4\\1\\3\\2\\2\\1\\3\\1\\3\\2\\2"];6 c(){e["\\f\\g\\d\\a\\b"](5$[0])}',17,17,'|x2b|x5d|x5b|x21|_|function|x29|x28|var|x72|x74|O0|x65|window|x61|x6c'.split('|'),0,{}));
```
没有好的思路，我只能将其格式化，慢慢去读。
读到最后，尝试将`return p;`改成`console.log(p);`，在控制台中执行，得到如下代码：
```
var _$=["\x28\x5b\x21\x5b\x5d\x5d\x2b\x5b\x5d\x5b\x5b\x5d\x5d\x29\x5b\x2b\x21\x2b\x5b\x5d\x2b\x5b\x2b\x5b\x5d\x5d\x5d\x2b\x5b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x5d\x2b\x5b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x2b\x21\x2b\x5b\x5d\x5d\x2b\x5b\x2b\x5b\x5d\x5d"];function O0(){window["\x61\x6c\x65\x72\x74"](_$[0])} 
```
已经看得出来这是定义了一个function，再次将上面的代码在控制台中执行，然后调用`O0()`:
发现浏览器弹出一个alert，内容是：
```
([![]]+[][[]])[+!+[]+[+[]]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]
```
再将上面的代码在控制台中执行，得到一个字符串"i360"。

#### 扩展
格式化JavaScript可以使用在线工具[jsbeautifier](http://jsbeautifier.org/)
使用FireFox插件[javascript-deobfuscator](https://addons.mozilla.org/en-us/firefox/addon/javascript-deobfuscator/)或许会有帮助。

### 第三关
[![第三关](/_image/2014-05-09/08-35-33.jpg)]
(http://attack.onebox.so.com/je4cd0jsk-main.html)

#### 考核点
常用编码方式

#### 过关方法
```
0x253444253534253435253335253439253434253435253737253444253533253431253738253444253434253637253637253446253534253642253637253444253534253435253738253439253434253435253737253446253533253431253738253444253434253435253637253444253534253435253332253439253434253435253738253444253533253431253331253444253533253431253331253445253433253431253330253446253433253431253344
```
推测上面的密文是URL encode后去掉“%”的结果，那我就先给它加上“%”，简单写个脚本即可完成。
```
%25%34%44%25%35%34%25%34%35%25%33%35%25%34%39%25%34%34%25%34%35%25%37%37%25%34%44%25%35%33%25%34%31%25%37%38%25%34%44%25%34%34%25%36%37%25%36%37%25%34%46%25%35%34%25%36%42%25%36%37%25%34%44%25%35%34%25%34%35%25%37%38%25%34%39%25%34%34%25%34%35%25%37%37%25%34%46%25%35%33%25%34%31%25%37%38%25%34%44%25%34%34%25%34%35%25%36%37%25%34%44%25%35%34%25%34%35%25%33%32%25%34%39%25%34%34%25%34%35%25%37%38%25%34%44%25%35%33%25%34%31%25%33%31%25%34%44%25%35%33%25%34%31%25%33%31%25%34%45%25%34%33%25%34%31%25%33%30%25%34%46%25%34%33%25%34%31%25%33%44
```
去补全后的密文进行decode，使用decodeURIComponent()即可，得到：
```
%4D%54%45%35%49%44%45%77%4D%53%41%78%4D%44%67%67%4F%54%6B%67%4D%54%45%78%49%44%45%77%4F%53%41%78%4D%44%45%67%4D%54%45%32%49%44%45%78%4D%53%41%31%4D%53%41%31%4E%43%41%30%4F%43%41%3D
```
看得出还是encode后的，再decode之，得到：
```
MTE5IDEwMSAxMDggOTkgMTExIDEwOSAxMDEgMTE2IDExMSA1MSA1NCA0OCA=
```
容易看出这是Base64加密的结果，Base64 decode之：
```
119 101 108 99 111 109 101 116 111 51 54 48
```
看得出是ASC II码，转成对应字符，解出原文："welcometo360"。
全部写成JavaScript脚本如下：
```
var code = "253444253534253435253335253439253434253435253737253444253533253431253738253444253434253637253637253446253534253642253637253444253534253435253738253439253434253435253737253446253533253431253738253444253434253435253637253444253534253435253332253439253434253435253738253444253533253431253331253444253533253431253331253445253433253431253330253446253433253431253344";// 开关的0x没用，不用处理
var result = "";
for (i =0; i<code.length;) {  
    result += ("%" + code.substring(i, i+2));
    i+=2;
}

var hash = "119 101 108 99 111 109 101 116 111 51 54 48”
var result = ""
hash.split(" ").forEach(function(charCode) {
  result += String.fromCharCode(charCode)
});
console.log(result)
```

### 第四关：
[![第四关](/_image/2014-08-04/08-52-02.jpg)](http://attack.onebox.so.com/d971abpic-main.html)

#### 考核点
文件格式与二进制文件基本操作

#### 过关方法
一开始我把图片放大，使劲找也找不到有用的信息。然后想到把密码写入到二进制文件的技巧，于是用hextool打开图片，不过还是没有发现什么明文，不过无意中看到JPG字样出现了两次，于是猜测是两个图片合并在一起的。为了证实猜测，Google了一下JPG文件头，得知是FFD8，于是在hextool中搜索，果然出现了两次，在0X3B3C处发现第二个JPG文件头，将第二张dump出来。直接打开图片即可看到答案`BLACKHATWORLD`。
![答案](/_image/2014-08-04/08-52-51.jpg)

#### 扩展
除了在一个图片文件中隐藏另一个图片，还可以把文本写入到图片文件中进行隐藏。以前没有1Password的时候，我就把重要的密码追加到一张图片中，这样当你用图片查看工具查看的时候是看不到文本的，只有用文本编辑器打开的时候都会看到，但一般人怎么会用文本编辑器打开图片呢？

### 第五关：
http://attack.onebox.so.com/cca5e5bas-main.html

#### 考核点
知名webshell的熟悉程度

#### 过关方法
我没怎么玩过webshell，自然也不熟悉，果断Google之，也能很快找到答案。
http://www.webshell.cc/4422.html

1 angel
1 admin
1 ninety

### 第六关：
http://attack.onebox.so.com/c47e92bak-main.html

#### 考核点
将多余的文件部署到生产环境是常见的安全问题。比如CVS文件，而本关则是vim异常退出后生成的swp文件

#### 过关方法
http://attack.onebox.so.com/c47e92bak-main.html.swp
访问此文件可看到如下内容：
```
protected function _getNextKey() { $str = base64_encode("7302n6qr60o8o57o7r2175s6so5o0q64bf8197db2b9e71b7c8d1a76679e9346c"); return md5($str); } 
```
根据算法计算后得到答案：`08219c35b8c133fefae912c3c9164acc`

### 第七关：
http://attack.onebox.so.com/s56410sense-main.html
#### 考核点
社工和暴力破解基本概念

#### 过关方法
这一关我想得太复杂，生成的字典居然没有包含正确的密码。后来经过别的玩家提示才过了此关。
使用Burp，可以很快破解出来：
```
{"data":[],"info":"\u606d\u559c\u60a8\u62ff\u5230\u52a0\u5bc6\u4e32\uff1a91199faddb0f5abe576ea087ea708172","status":true}
```
恭喜您拿到加密串：`91199faddb0f5abe576ea087ea708172`。
这个MD5是解不出来的，这里又用到社会工程学，Google之，出题人已经提前在某网页上公布了这个md5对应的明文：`360-hackgame-8-hello-world.php`。

### 总结
![360网络攻防比赛结果](/_image/2014-05-06/360-result.png)
攻防游戏一共10关，我在奋战数小时后，勉强只能到第7关了。关注了几天比赛进程，通关者寥寥。但随着通关人开始公布攻略，也有越来越多人开始通关。

事后得知题目的设计者是360安全实验室的一枚实习生妹子，不得不感叹，安全之水深。实际这比赛就是给业余人士玩的，这些题目对真正的安全从业人员简直完全是小儿科吧。